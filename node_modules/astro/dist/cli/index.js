import { enableVerboseLogging } from "../core/logger.js";
import * as colors from "kleur/colors";
import fs from "fs";
import yargs from "yargs-parser";
import { z } from "zod";
import { defaultLogDestination } from "../core/logger.js";
import build from "../core/build/index.js";
import devServer from "../core/dev/index.js";
import preview from "../core/preview/index.js";
import { check } from "./check.js";
import { formatConfigError, loadConfig } from "../core/config.js";
function printHelp() {
  console.log(`  ${colors.bold("astro")} - Futuristic web development tool.
  ${colors.bold("Commands:")}
  astro dev             Run Astro in development mode.
  astro build           Build a pre-compiled production version of your site.
  astro preview         Preview your build locally before deploying.
  astro check           Check your project for errors.

  ${colors.bold("Flags:")}
  --config <path>				Specify the path to the Astro config file.
  --project-root <path>			Specify the path to the project root folder.
  --no-sitemap					Disable sitemap generation (build only).
  --experimental-static-build	A more performant build that expects assets to be define statically.
	--experimental-ssr		Enable SSR compilation.
  --drafts                      Include markdown draft pages in the build.
  --verbose						Enable verbose logging
  --silent						Disable logging
  --version						Show the version number and exit.
  --help						Show this help message.
`);
}
async function printVersion() {
  const pkgURL = new URL("../../package.json", import.meta.url);
  const pkg = JSON.parse(await fs.promises.readFile(pkgURL, "utf8"));
  const pkgVersion = pkg.version;
  console.log(pkgVersion);
}
function resolveCommand(flags) {
  if (flags.version) {
    return "version";
  } else if (flags.help) {
    return "help";
  }
  const cmd = flags._[2];
  const supportedCommands = new Set(["dev", "build", "preview", "check"]);
  if (supportedCommands.has(cmd)) {
    return cmd;
  }
  return "help";
}
async function cli(args) {
  const flags = yargs(args);
  const cmd = resolveCommand(flags);
  const projectRoot = flags.projectRoot || flags._[3];
  switch (cmd) {
    case "help":
      printHelp();
      return process.exit(0);
    case "version":
      await printVersion();
      return process.exit(0);
  }
  let logging = {
    dest: defaultLogDestination,
    level: "info"
  };
  if (flags.verbose) {
    logging.level = "debug";
    enableVerboseLogging();
  } else if (flags.silent) {
    logging.level = "silent";
  }
  let config;
  try {
    config = await loadConfig({ cwd: projectRoot, flags });
  } catch (err) {
    throwAndExit(err);
    return;
  }
  switch (cmd) {
    case "dev": {
      try {
        await devServer(config, { logging });
        await new Promise(() => {
        });
      } catch (err) {
        throwAndExit(err);
      }
      return;
    }
    case "build": {
      try {
        await build(config, { logging });
        process.exit(0);
      } catch (err) {
        throwAndExit(err);
      }
      return;
    }
    case "check": {
      const ret = await check(config);
      return process.exit(ret);
    }
    case "preview": {
      try {
        await preview(config, { logging });
      } catch (err) {
        throwAndExit(err);
      }
      return;
    }
    default: {
      throw new Error(`Error running ${cmd}`);
    }
  }
}
function throwAndExit(err) {
  if (err instanceof z.ZodError) {
    console.error(formatConfigError(err));
  } else if (err.stack) {
    const [mainMsg, ...stackMsg] = err.stack.split("\n");
    console.error(colors.red(mainMsg) + "\n" + colors.dim(stackMsg.join("\n")));
  } else {
    console.error(colors.red(err.toString() || err));
  }
  process.exit(1);
}
export {
  cli
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vc3JjL2NsaS9pbmRleC50cyJdLAogICJtYXBwaW5ncyI6ICJBQUdBO0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFNQSxxQkFBcUI7QUFDcEIsVUFBUSxJQUFJLEtBQUssT0FBTyxLQUFLO0FBQUEsSUFDMUIsT0FBTyxLQUFLO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLElBTVosT0FBTyxLQUFLO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBZWhCLDhCQUE4QjtBQUM3QixRQUFNLFNBQVMsSUFBSSxJQUFJLHNCQUFzQixZQUFZO0FBQ3pELFFBQU0sTUFBTSxLQUFLLE1BQU0sTUFBTSxHQUFHLFNBQVMsU0FBUyxRQUFRO0FBQzFELFFBQU0sYUFBYSxJQUFJO0FBRXZCLFVBQVEsSUFBSTtBQUFBO0FBSWIsd0JBQXdCLE9BQThCO0FBQ3JELE1BQUksTUFBTSxTQUFTO0FBQ2xCLFdBQU87QUFBQSxhQUNHLE1BQU0sTUFBTTtBQUN0QixXQUFPO0FBQUE7QUFFUixRQUFNLE1BQU0sTUFBTSxFQUFFO0FBQ3BCLFFBQU0sb0JBQW9CLElBQUksSUFBSSxDQUFDLE9BQU8sU0FBUyxXQUFXO0FBQzlELE1BQUksa0JBQWtCLElBQUksTUFBTTtBQUMvQixXQUFPO0FBQUE7QUFFUixTQUFPO0FBQUE7QUFJUixtQkFBMEIsTUFBZ0I7QUFDekMsUUFBTSxRQUFRLE1BQU07QUFDcEIsUUFBTSxNQUFNLGVBQWU7QUFDM0IsUUFBTSxjQUFjLE1BQU0sZUFBZSxNQUFNLEVBQUU7QUFFakQsVUFBUTtBQUFBLFNBQ0Y7QUFDSjtBQUNBLGFBQU8sUUFBUSxLQUFLO0FBQUEsU0FDaEI7QUFDSixZQUFNO0FBQ04sYUFBTyxRQUFRLEtBQUs7QUFBQTtBQUl0QixNQUFJLFVBQXNCO0FBQUEsSUFDekIsTUFBTTtBQUFBLElBQ04sT0FBTztBQUFBO0FBRVIsTUFBSSxNQUFNLFNBQVM7QUFDbEIsWUFBUSxRQUFRO0FBQ2hCO0FBQUEsYUFDVSxNQUFNLFFBQVE7QUFDeEIsWUFBUSxRQUFRO0FBQUE7QUFHakIsTUFBSTtBQUNKLE1BQUk7QUFDSCxhQUFTLE1BQU0sV0FBVyxFQUFFLEtBQUssYUFBYTtBQUFBLFdBQ3RDLEtBQVA7QUFDRCxpQkFBYTtBQUNiO0FBQUE7QUFHRCxVQUFRO0FBQUEsU0FDRixPQUFPO0FBQ1gsVUFBSTtBQUNILGNBQU0sVUFBVSxRQUFRLEVBQUU7QUFFMUIsY0FBTSxJQUFJLFFBQVEsTUFBTTtBQUFBO0FBQUEsZUFDaEIsS0FBUDtBQUNELHFCQUFhO0FBQUE7QUFHZDtBQUFBO0FBQUEsU0FHSSxTQUFTO0FBQ2IsVUFBSTtBQUNILGNBQU0sTUFBTSxRQUFRLEVBQUU7QUFDdEIsZ0JBQVEsS0FBSztBQUFBLGVBQ0wsS0FBUDtBQUNELHFCQUFhO0FBQUE7QUFFZDtBQUFBO0FBQUEsU0FHSSxTQUFTO0FBQ2IsWUFBTSxNQUFNLE1BQU0sTUFBTTtBQUN4QixhQUFPLFFBQVEsS0FBSztBQUFBO0FBQUEsU0FHaEIsV0FBVztBQUNmLFVBQUk7QUFDSCxjQUFNLFFBQVEsUUFBUSxFQUFFO0FBQUEsZUFDaEIsS0FBUDtBQUNELHFCQUFhO0FBQUE7QUFFZDtBQUFBO0FBQUEsYUFHUTtBQUNSLFlBQU0sSUFBSSxNQUFNLGlCQUFpQjtBQUFBO0FBQUE7QUFBQTtBQU1wQyxzQkFBc0IsS0FBVTtBQUMvQixNQUFJLGVBQWUsRUFBRSxVQUFVO0FBQzlCLFlBQVEsTUFBTSxrQkFBa0I7QUFBQSxhQUN0QixJQUFJLE9BQU87QUFDckIsVUFBTSxDQUFDLFlBQVksWUFBWSxJQUFJLE1BQU0sTUFBTTtBQUMvQyxZQUFRLE1BQU0sT0FBTyxJQUFJLFdBQVcsT0FBTyxPQUFPLElBQUksU0FBUyxLQUFLO0FBQUEsU0FDOUQ7QUFDTixZQUFRLE1BQU0sT0FBTyxJQUFJLElBQUksY0FBYztBQUFBO0FBRTVDLFVBQVEsS0FBSztBQUFBOyIsCiAgIm5hbWVzIjogW10KfQo=
