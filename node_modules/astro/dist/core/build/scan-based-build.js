import { fileURLToPath } from "url";
import * as vite from "vite";
import { createBuildInternals } from "../../core/build/internal.js";
import { rollupPluginAstroBuildHTML } from "../../vite-plugin-build-html/index.js";
import { rollupPluginAstroBuildCSS } from "../../vite-plugin-build-css/index.js";
function entryIsType(type) {
  return function withPage([_, pageData]) {
    return pageData.route.type === type;
  };
}
function reduceEntries(acc, [key, value]) {
  acc[key] = value;
  return acc;
}
function routesOfType(type, allPages) {
  return Object.entries(allPages).filter(entryIsType(type)).reduce(reduceEntries, {});
}
async function build(opts) {
  const { allPages, astroConfig, logging, origin, pageNames, routeCache, viteConfig, viteServer } = opts;
  const internals = createBuildInternals();
  return await vite.build({
    logLevel: "error",
    mode: "production",
    build: {
      emptyOutDir: true,
      minify: "esbuild",
      outDir: fileURLToPath(astroConfig.dist),
      rollupOptions: {
        input: [],
        output: {
          format: "esm"
        }
      },
      target: "es2020"
    },
    plugins: [
      rollupPluginAstroBuildHTML({
        astroConfig,
        internals,
        logging,
        origin,
        allPages: routesOfType("page", allPages),
        pageNames,
        routeCache,
        viteServer
      }),
      rollupPluginAstroBuildCSS({
        internals
      }),
      ...viteConfig.plugins || []
    ],
    publicDir: viteConfig.publicDir,
    root: viteConfig.root,
    envPrefix: "PUBLIC_",
    server: viteConfig.server,
    base: astroConfig.buildOptions.site ? new URL(astroConfig.buildOptions.site).pathname : "/"
  });
}
export {
  build
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvYnVpbGQvc2Nhbi1iYXNlZC1idWlsZC50cyJdLAogICJtYXBwaW5ncyI6ICJBQU1BO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFlQSxxQkFBcUIsTUFBaUI7QUFDckMsU0FBTyxrQkFBa0IsQ0FBQyxHQUFHLFdBQW9DO0FBQ2hFLFdBQU8sU0FBUyxNQUFNLFNBQVM7QUFBQTtBQUFBO0FBS2pDLHVCQUEwQixLQUEyQixDQUFDLEtBQUssUUFBcUI7QUFDL0UsTUFBSSxPQUFPO0FBQ1gsU0FBTztBQUFBO0FBSVIsc0JBQXNCLE1BQWlCLFVBQXdCO0FBQzlELFNBQU8sT0FBTyxRQUFRLFVBQVUsT0FBTyxZQUFZLE9BQU8sT0FBTyxlQUFlO0FBQUE7QUFHakYscUJBQTRCLE1BQTZCO0FBQ3hELFFBQU0sRUFBRSxVQUFVLGFBQWEsU0FBUyxRQUFRLFdBQVcsWUFBWSxZQUFZLGVBQWU7QUFHbEcsUUFBTSxZQUFZO0FBRWxCLFNBQU8sTUFBTSxLQUFLLE1BQU07QUFBQSxJQUN2QixVQUFVO0FBQUEsSUFDVixNQUFNO0FBQUEsSUFDTixPQUFPO0FBQUEsTUFDTixhQUFhO0FBQUEsTUFDYixRQUFRO0FBQUEsTUFDUixRQUFRLGNBQWMsWUFBWTtBQUFBLE1BQ2xDLGVBQWU7QUFBQSxRQUVkLE9BQU87QUFBQSxRQUNQLFFBQVE7QUFBQSxVQUNQLFFBQVE7QUFBQTtBQUFBO0FBQUEsTUFHVixRQUFRO0FBQUE7QUFBQSxJQUVULFNBQVM7QUFBQSxNQUNSLDJCQUEyQjtBQUFBLFFBQzFCO0FBQUEsUUFDQTtBQUFBLFFBQ0E7QUFBQSxRQUNBO0FBQUEsUUFDQSxVQUFVLGFBQWEsUUFBUTtBQUFBLFFBQy9CO0FBQUEsUUFDQTtBQUFBLFFBQ0E7QUFBQTtBQUFBLE1BRUQsMEJBQTBCO0FBQUEsUUFDekI7QUFBQTtBQUFBLE1BRUQsR0FBSSxXQUFXLFdBQVc7QUFBQTtBQUFBLElBRTNCLFdBQVcsV0FBVztBQUFBLElBQ3RCLE1BQU0sV0FBVztBQUFBLElBQ2pCLFdBQVc7QUFBQSxJQUNYLFFBQVEsV0FBVztBQUFBLElBQ25CLE1BQU0sWUFBWSxhQUFhLE9BQU8sSUFBSSxJQUFJLFlBQVksYUFBYSxNQUFNLFdBQVc7QUFBQTtBQUFBOyIsCiAgIm5hbWVzIjogW10KfQo=
