import fs from "fs";
import npath from "path";
import { fileURLToPath } from "url";
import glob from "fast-glob";
import * as vite from "vite";
import { debug, error } from "../../core/logger.js";
import { prependForwardSlash, appendForwardSlash } from "../../core/path.js";
import { createBuildInternals } from "../../core/build/internal.js";
import { rollupPluginAstroBuildCSS } from "../../vite-plugin-build-css/index.js";
import { emptyDir, prepareOutDir } from "./fs.js";
import { vitePluginHoistedScripts } from "./vite-plugin-hoisted-scripts.js";
import { serializeRouteData } from "../routing/index.js";
import { render } from "../render/core.js";
import { createLinkStylesheetElementSet, createModuleScriptElementWithSrcSet } from "../render/ssr-element.js";
const MAX_CONCURRENT_RENDERS = 10;
function addPageName(pathname, opts) {
  const pathrepl = opts.astroConfig.buildOptions.pageUrlFormat === "directory" ? "/index.html" : pathname === "/" ? "index.html" : ".html";
  opts.pageNames.push(pathname.replace(/\/?$/, pathrepl).replace(/^\//, ""));
}
function rootRelativeFacadeId(facadeId, astroConfig) {
  return facadeId.slice(fileURLToPath(astroConfig.projectRoot).length);
}
function chunkIsPage(astroConfig, output, internals) {
  if (output.type !== "chunk") {
    return false;
  }
  const chunk = output;
  if (chunk.facadeModuleId) {
    const facadeToEntryId = prependForwardSlash(rootRelativeFacadeId(chunk.facadeModuleId, astroConfig));
    return internals.entrySpecifierToBundleMap.has(facadeToEntryId);
  }
  return false;
}
function* throttle(max, inPaths) {
  let tmp = [];
  let i = 0;
  for (let path of inPaths) {
    tmp.push(path);
    if (i === max) {
      yield tmp;
      tmp.length = 0;
      i = 0;
    } else {
      i++;
    }
  }
  if (tmp.length) {
    yield tmp;
  }
}
function getByFacadeId(facadeId, map) {
  return map.get(facadeId) || map.get(facadeId.replace(/\//g, "\\"));
}
async function staticBuild(opts) {
  const { allPages, astroConfig } = opts;
  const staticMode = !astroConfig.buildOptions.experimentalSsr;
  const pageInput = new Set();
  const jsInput = new Set();
  const facadeIdToPageDataMap = new Map();
  const polyfills = getRenderers(opts).flatMap((renderer) => {
    return (renderer.polyfills || []).concat(renderer.hydrationPolyfills || []);
  });
  for (const polyfill of polyfills) {
    jsInput.add(polyfill);
  }
  const internals = createBuildInternals();
  for (const [component, pageData] of Object.entries(allPages)) {
    const astroModuleURL = new URL("./" + component, astroConfig.projectRoot);
    const astroModuleId = prependForwardSlash(component);
    if (pageData.route.type === "page") {
      const [renderers, mod] = pageData.preload;
      const metadata = mod.$$metadata;
      const topLevelImports = new Set([
        ...metadata.hydratedComponentPaths(),
        ...metadata.hydrationDirectiveSpecifiers(),
        ...renderers.filter((renderer) => !!renderer.source).map((renderer) => renderer.source)
      ]);
      const hoistedScripts = new Set(metadata.hoistedScriptPaths());
      if (hoistedScripts.size) {
        const moduleId = npath.posix.join(astroModuleId, "hoisted.js");
        internals.hoistedScriptIdToHoistedMap.set(moduleId, hoistedScripts);
        topLevelImports.add(moduleId);
      }
      for (const specifier of topLevelImports) {
        jsInput.add(specifier);
      }
    }
    pageInput.add(astroModuleId);
    facadeIdToPageDataMap.set(fileURLToPath(astroModuleURL), pageData);
  }
  prepareOutDir(astroConfig);
  const [ssrResult] = await Promise.all([ssrBuild(opts, internals, pageInput), clientBuild(opts, internals, jsInput)]);
  if (staticMode) {
    await generatePages(ssrResult, opts, internals, facadeIdToPageDataMap);
    await cleanSsrOutput(opts);
  } else {
    await generateManifest(ssrResult, opts, internals);
    await ssrMoveAssets(opts);
  }
}
async function ssrBuild(opts, internals, input) {
  const { astroConfig, viteConfig } = opts;
  const ssr = astroConfig.buildOptions.experimentalSsr;
  const out = ssr ? getServerRoot(astroConfig) : getOutRoot(astroConfig);
  return await vite.build({
    logLevel: "error",
    mode: "production",
    build: {
      emptyOutDir: false,
      manifest: ssr,
      minify: false,
      outDir: fileURLToPath(out),
      ssr: true,
      rollupOptions: {
        input: Array.from(input),
        output: {
          format: "esm",
          entryFileNames: "[name].[hash].mjs",
          chunkFileNames: "chunks/[name].[hash].mjs",
          assetFileNames: "assets/[name].[hash][extname]"
        }
      },
      target: "esnext"
    },
    plugins: [
      vitePluginNewBuild(input, internals, "mjs"),
      rollupPluginAstroBuildCSS({
        internals
      }),
      ...viteConfig.plugins || []
    ],
    publicDir: ssr ? false : viteConfig.publicDir,
    root: viteConfig.root,
    envPrefix: "PUBLIC_",
    server: viteConfig.server,
    base: astroConfig.buildOptions.site ? new URL(astroConfig.buildOptions.site).pathname : "/",
    ssr: viteConfig.ssr
  });
}
async function clientBuild(opts, internals, input) {
  const { astroConfig, viteConfig } = opts;
  if (!input.size) {
    return null;
  }
  const out = astroConfig.buildOptions.experimentalSsr ? getClientRoot(astroConfig) : getOutRoot(astroConfig);
  return await vite.build({
    logLevel: "error",
    mode: "production",
    build: {
      emptyOutDir: false,
      minify: "esbuild",
      outDir: fileURLToPath(out),
      rollupOptions: {
        input: Array.from(input),
        output: {
          format: "esm",
          entryFileNames: "[name].[hash].js",
          chunkFileNames: "chunks/[name].[hash].js",
          assetFileNames: "assets/[name].[hash][extname]"
        },
        preserveEntrySignatures: "exports-only"
      },
      target: "esnext"
    },
    plugins: [
      vitePluginNewBuild(input, internals, "js"),
      vitePluginHoistedScripts(astroConfig, internals),
      rollupPluginAstroBuildCSS({
        internals
      }),
      ...viteConfig.plugins || []
    ],
    publicDir: viteConfig.publicDir,
    root: viteConfig.root,
    envPrefix: "PUBLIC_",
    server: viteConfig.server,
    base: appendForwardSlash(astroConfig.buildOptions.site ? new URL(astroConfig.buildOptions.site).pathname : "/")
  });
}
function getRenderers(opts) {
  const pageData = Object.values(opts.allPages)[0];
  const viteLoadedRenderers = pageData.preload[0];
  return viteLoadedRenderers;
}
async function collectRenderers(opts) {
  const viteLoadedRenderers = getRenderers(opts);
  const renderers = await Promise.all(viteLoadedRenderers.map(async (r) => {
    const mod = await import(r.serverEntry);
    return Object.create(r, {
      ssr: {
        value: mod.default
      }
    });
  }));
  return renderers;
}
async function generatePages(result, opts, internals, facadeIdToPageDataMap) {
  debug("build", "Finish build. Begin generating.");
  const renderers = await collectRenderers(opts);
  const generationPromises = [];
  for (let output of result.output) {
    if (chunkIsPage(opts.astroConfig, output, internals)) {
      generationPromises.push(generatePage(output, opts, internals, facadeIdToPageDataMap, renderers));
    }
  }
  await Promise.all(generationPromises);
}
async function generatePage(output, opts, internals, facadeIdToPageDataMap, renderers) {
  const { astroConfig } = opts;
  let url = new URL("./" + output.fileName, getOutRoot(astroConfig));
  const facadeId = output.facadeModuleId;
  let pageData = getByFacadeId(facadeId, facadeIdToPageDataMap);
  if (!pageData) {
    throw new Error(`Unable to find a PageBuildData for the Astro page: ${facadeId}. There are the PageBuildDatas we have ${Array.from(facadeIdToPageDataMap.keys()).join(", ")}`);
  }
  const linkIds = getByFacadeId(facadeId, internals.facadeIdToAssetsMap) || [];
  const hoistedId = getByFacadeId(facadeId, internals.facadeIdToHoistedEntryMap) || null;
  let compiledModule = await import(url.toString());
  const generationOptions = {
    pageData,
    internals,
    linkIds,
    hoistedId,
    mod: compiledModule,
    renderers
  };
  const renderPromises = [];
  for (const paths of throttle(MAX_CONCURRENT_RENDERS, pageData.paths)) {
    for (const path of paths) {
      renderPromises.push(generatePath(path, opts, generationOptions));
    }
    await Promise.all(renderPromises);
    renderPromises.length = 0;
  }
}
async function generatePath(pathname, opts, gopts) {
  const { astroConfig, logging, origin, routeCache } = opts;
  const { mod, internals, linkIds, hoistedId, pageData, renderers } = gopts;
  if (pageData.route.type === "page") {
    addPageName(pathname, opts);
  }
  debug("build", `Generating: ${pathname}`);
  const site = astroConfig.buildOptions.site;
  const links = createLinkStylesheetElementSet(linkIds, site);
  const scripts = createModuleScriptElementWithSrcSet(hoistedId ? [hoistedId] : [], site);
  try {
    const html = await render({
      experimentalStaticBuild: true,
      links,
      logging,
      markdownRender: astroConfig.markdownOptions.render,
      mod,
      origin,
      pathname,
      scripts,
      renderers,
      async resolve(specifier) {
        const hashedFilePath = internals.entrySpecifierToBundleMap.get(specifier);
        if (typeof hashedFilePath !== "string") {
          throw new Error(`Cannot find the built path for ${specifier}`);
        }
        const relPath = npath.posix.relative(pathname, "/" + hashedFilePath);
        const fullyRelativePath = relPath[0] === "." ? relPath : "./" + relPath;
        return fullyRelativePath;
      },
      route: pageData.route,
      routeCache,
      site: astroConfig.buildOptions.site
    });
    const outFolder = getOutFolder(astroConfig, pathname, pageData.route.type);
    const outFile = getOutFile(astroConfig, outFolder, pathname, pageData.route.type);
    await fs.promises.mkdir(outFolder, { recursive: true });
    await fs.promises.writeFile(outFile, html, "utf-8");
  } catch (err) {
    error(opts.logging, "build", `Error rendering:`, err);
  }
}
async function generateManifest(result, opts, internals) {
  const { astroConfig, manifest } = opts;
  const manifestFile = new URL("./manifest.json", getServerRoot(astroConfig));
  const inputManifestJSON = await fs.promises.readFile(manifestFile, "utf-8");
  const data = JSON.parse(inputManifestJSON);
  const rootRelativeIdToChunkMap = new Map();
  for (const output of result.output) {
    if (chunkIsPage(astroConfig, output, internals)) {
      const chunk = output;
      if (chunk.facadeModuleId) {
        const id = rootRelativeFacadeId(chunk.facadeModuleId, astroConfig);
        rootRelativeIdToChunkMap.set(id, chunk);
      }
    }
  }
  const routes = [];
  for (const routeData of manifest.routes) {
    const componentPath = routeData.component;
    const entry = data[componentPath];
    if (!rootRelativeIdToChunkMap.has(componentPath)) {
      throw new Error("Unable to find chunk for " + componentPath);
    }
    const chunk = rootRelativeIdToChunkMap.get(componentPath);
    const facadeId = chunk.facadeModuleId;
    const links = getByFacadeId(facadeId, internals.facadeIdToAssetsMap) || [];
    const hoistedScript = getByFacadeId(facadeId, internals.facadeIdToHoistedEntryMap);
    const scripts = hoistedScript ? [hoistedScript] : [];
    routes.push({
      file: entry == null ? void 0 : entry.file,
      links,
      scripts,
      routeData: serializeRouteData(routeData)
    });
  }
  const ssrManifest = {
    routes,
    site: astroConfig.buildOptions.site,
    markdown: {
      render: astroConfig.markdownOptions.render
    },
    renderers: astroConfig.renderers,
    entryModules: Object.fromEntries(internals.entrySpecifierToBundleMap.entries())
  };
  const outputManifestJSON = JSON.stringify(ssrManifest, null, "  ");
  await fs.promises.writeFile(manifestFile, outputManifestJSON, "utf-8");
}
function getOutRoot(astroConfig) {
  const rootPathname = appendForwardSlash(astroConfig.buildOptions.site ? new URL(astroConfig.buildOptions.site).pathname : "/");
  return new URL("." + rootPathname, astroConfig.dist);
}
function getServerRoot(astroConfig) {
  const rootFolder = getOutRoot(astroConfig);
  const serverFolder = new URL("./server/", rootFolder);
  return serverFolder;
}
function getClientRoot(astroConfig) {
  const rootFolder = getOutRoot(astroConfig);
  const serverFolder = new URL("./client/", rootFolder);
  return serverFolder;
}
function getOutFolder(astroConfig, pathname, routeType) {
  const outRoot = getOutRoot(astroConfig);
  switch (routeType) {
    case "endpoint":
      return new URL("." + appendForwardSlash(npath.dirname(pathname)), outRoot);
    case "page":
      switch (astroConfig.buildOptions.pageUrlFormat) {
        case "directory":
          return new URL("." + appendForwardSlash(pathname), outRoot);
        case "file":
          return new URL("." + appendForwardSlash(npath.dirname(pathname)), outRoot);
      }
  }
}
function getOutFile(astroConfig, outFolder, pathname, routeType) {
  switch (routeType) {
    case "endpoint":
      return new URL(npath.basename(pathname), outFolder);
    case "page":
      switch (astroConfig.buildOptions.pageUrlFormat) {
        case "directory":
          return new URL("./index.html", outFolder);
        case "file":
          return new URL("./" + npath.basename(pathname) + ".html", outFolder);
      }
  }
}
async function cleanSsrOutput(opts) {
  const files = await glob("**/*.mjs", {
    cwd: fileURLToPath(opts.astroConfig.dist)
  });
  await Promise.all(files.map(async (filename) => {
    const url = new URL(filename, opts.astroConfig.dist);
    await fs.promises.rm(url);
  }));
}
async function ssrMoveAssets(opts) {
  const { astroConfig } = opts;
  const serverRoot = getServerRoot(astroConfig);
  const clientRoot = getClientRoot(astroConfig);
  const serverAssets = new URL("./assets/", serverRoot);
  const clientAssets = new URL("./assets/", clientRoot);
  const files = await glob("assets/**/*", {
    cwd: fileURLToPath(serverRoot)
  });
  await fs.promises.mkdir(clientAssets, { recursive: true });
  await Promise.all(files.map(async (filename) => {
    const currentUrl = new URL(filename, serverRoot);
    const clientUrl = new URL(filename, clientRoot);
    return fs.promises.rename(currentUrl, clientUrl);
  }));
  await emptyDir(fileURLToPath(serverAssets));
  if (fs.existsSync(serverAssets)) {
    await fs.promises.rmdir(serverAssets);
  }
}
function vitePluginNewBuild(input, internals, ext) {
  return {
    name: "@astro/rollup-plugin-new-build",
    config(config, options) {
      var _a;
      const extra = {};
      const noExternal = [], external = [];
      if (options.command === "build" && ((_a = config.build) == null ? void 0 : _a.ssr)) {
        noExternal.push("astro");
        external.push("shiki");
      }
      extra.ssr = {
        external,
        noExternal
      };
      return extra;
    },
    configResolved(resolvedConfig) {
      const plugins = resolvedConfig.plugins;
      const viteAsset = plugins.find((p) => p.name === "vite:asset");
      if (viteAsset) {
        delete viteAsset.generateBundle;
      }
    },
    async generateBundle(_options, bundle) {
      const promises = [];
      const mapping = new Map();
      for (const specifier of input) {
        promises.push(this.resolve(specifier).then((result) => {
          if (result) {
            mapping.set(result.id, specifier);
          }
        }));
      }
      await Promise.all(promises);
      for (const [, chunk] of Object.entries(bundle)) {
        if (chunk.type === "chunk" && chunk.facadeModuleId && mapping.has(chunk.facadeModuleId)) {
          const specifier = mapping.get(chunk.facadeModuleId);
          internals.entrySpecifierToBundleMap.set(specifier, chunk.fileName);
        }
      }
    }
  };
}
export {
  staticBuild,
  vitePluginNewBuild
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvYnVpbGQvc3RhdGljLWJ1aWxkLnRzIl0sCiAgIm1hcHBpbmdzIjogIkFBVUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBO0FBQ0E7QUFDQTtBQWFBLE1BQU0seUJBQXlCO0FBRS9CLHFCQUFxQixVQUFrQixNQUFnQztBQUN0RSxRQUFNLFdBQVcsS0FBSyxZQUFZLGFBQWEsa0JBQWtCLGNBQWMsZ0JBQWdCLGFBQWEsTUFBTSxlQUFlO0FBQ2pJLE9BQUssVUFBVSxLQUFLLFNBQVMsUUFBUSxRQUFRLFVBQVUsUUFBUSxPQUFPO0FBQUE7QUFLdkUsOEJBQThCLFVBQWtCLGFBQWtDO0FBQ2pGLFNBQU8sU0FBUyxNQUFNLGNBQWMsWUFBWSxhQUFhO0FBQUE7QUFJOUQscUJBQXFCLGFBQTBCLFFBQW1DLFdBQTJCO0FBQzVHLE1BQUksT0FBTyxTQUFTLFNBQVM7QUFDNUIsV0FBTztBQUFBO0FBRVIsUUFBTSxRQUFRO0FBQ2QsTUFBSSxNQUFNLGdCQUFnQjtBQUN6QixVQUFNLGtCQUFrQixvQkFBb0IscUJBQXFCLE1BQU0sZ0JBQWdCO0FBQ3ZGLFdBQU8sVUFBVSwwQkFBMEIsSUFBSTtBQUFBO0FBRWhELFNBQU87QUFBQTtBQUlSLG1CQUFtQixLQUFhLFNBQW1CO0FBQ2xELE1BQUksTUFBTTtBQUNWLE1BQUksSUFBSTtBQUNSLFdBQVMsUUFBUSxTQUFTO0FBQ3pCLFFBQUksS0FBSztBQUNULFFBQUksTUFBTSxLQUFLO0FBQ2QsWUFBTTtBQUVOLFVBQUksU0FBUztBQUNiLFVBQUk7QUFBQSxXQUNFO0FBQ047QUFBQTtBQUFBO0FBTUYsTUFBSSxJQUFJLFFBQVE7QUFDZixVQUFNO0FBQUE7QUFBQTtBQUlSLHVCQUEwQixVQUFrQixLQUFvQztBQUMvRSxTQUNDLElBQUksSUFBSSxhQUVSLElBQUksSUFBSSxTQUFTLFFBQVEsT0FBTztBQUFBO0FBSWxDLDJCQUFrQyxNQUEw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
