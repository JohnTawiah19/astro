import { fileURLToPath } from "url";
import * as colors from "kleur/colors";
import { debug } from "../logger.js";
import { preload as ssrPreload } from "../render/dev/index.js";
import { generateRssFunction } from "../render/rss.js";
import { callGetStaticPaths } from "../render/route-cache.js";
async function collectPagesData(opts) {
  var _a;
  const { astroConfig, logging, manifest, origin, routeCache, viteServer } = opts;
  const assets = {};
  const allPages = {};
  for (const route of manifest.routes) {
    if (route.pathname) {
      allPages[route.component] = {
        route,
        paths: [route.pathname],
        preload: await ssrPreload({
          astroConfig,
          filePath: new URL(`./${route.component}`, astroConfig.projectRoot),
          logging,
          mode: "production",
          origin,
          pathname: route.pathname,
          route,
          routeCache,
          viteServer
        }).then((routes) => {
          const html = `${route.pathname}`.replace(/\/?$/, "/index.html");
          debug("build", `\u251C\u2500\u2500 ${colors.bold(colors.green("\u2714"))} ${route.component} \u2192 ${colors.yellow(html)}`);
          return routes;
        }).catch((err) => {
          debug("build", `\u251C\u2500\u2500 ${colors.bold(colors.red("\u2718"))} ${route.component}`);
          throw err;
        })
      };
      continue;
    }
    const result = await getStaticPathsForRoute(opts, route).then((_result) => {
      const label = _result.staticPaths.length === 1 ? "page" : "pages";
      debug("build", `\u251C\u2500\u2500 ${colors.bold(colors.green("\u2714"))} ${route.component} \u2192 ${colors.magenta(`[${_result.staticPaths.length} ${label}]`)}`);
      return _result;
    }).catch((err) => {
      debug("build", `\u251C\u2500\u2500 ${colors.bold(colors.red("\u2717"))} ${route.component}`);
      throw err;
    });
    const rssFn = generateRssFunction(astroConfig.buildOptions.site, route);
    for (const rssCallArg of result.rss) {
      const rssResult = rssFn(rssCallArg);
      if (rssResult.xml) {
        const { url, content } = rssResult.xml;
        if (content) {
          const rssFile = new URL(url.replace(/^\/?/, "./"), astroConfig.dist);
          if (assets[fileURLToPath(rssFile)]) {
            throw new Error(`[getStaticPaths] RSS feed ${url} already exists.
Use \`rss(data, {url: '...'})\` to choose a unique, custom URL. (${route.component})`);
          }
          assets[fileURLToPath(rssFile)] = content;
        }
      }
      if ((_a = rssResult.xsl) == null ? void 0 : _a.content) {
        const { url, content } = rssResult.xsl;
        const stylesheetFile = new URL(url.replace(/^\/?/, "./"), astroConfig.dist);
        if (assets[fileURLToPath(stylesheetFile)]) {
          throw new Error(`[getStaticPaths] RSS feed stylesheet ${url} already exists.
Use \`rss(data, {stylesheet: '...'})\` to choose a unique, custom URL. (${route.component})`);
        }
        assets[fileURLToPath(stylesheetFile)] = content;
      }
    }
    const finalPaths = result.staticPaths.map((staticPath) => staticPath.params && route.generate(staticPath.params)).filter(Boolean);
    allPages[route.component] = {
      route,
      paths: finalPaths,
      preload: await ssrPreload({
        astroConfig,
        filePath: new URL(`./${route.component}`, astroConfig.projectRoot),
        logging,
        mode: "production",
        origin,
        pathname: finalPaths[0],
        route,
        routeCache,
        viteServer
      })
    };
  }
  return { assets, allPages };
}
async function getStaticPathsForRoute(opts, route) {
  const { astroConfig, logging, routeCache, viteServer } = opts;
  if (!viteServer)
    throw new Error(`vite.createServer() not called!`);
  const filePath = new URL(`./${route.component}`, astroConfig.projectRoot);
  const mod = await viteServer.ssrLoadModule(fileURLToPath(filePath));
  const result = await callGetStaticPaths(mod, route, false, logging);
  routeCache.set(route, result);
  return result;
}
export {
  collectPagesData
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvYnVpbGQvcGFnZS1kYXRhLnRzIl0sCiAgIm1hcHBpbmdzIjogIkFBS0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBaUJBLGdDQUF1QyxNQUFnRTtBQTNCdkc7QUE0QkMsUUFBTSxFQUFFLGFBQWEsU0FBUyxVQUFVLFFBQVEsWUFBWSxlQUFlO0FBRTNFLFFBQU0sU0FBaUM7QUFDdkMsUUFBTSxXQUF5QjtBQU0vQixhQUFXLFNBQVMsU0FBUyxRQUFRO0FBRXBDLFFBQUksTUFBTSxVQUFVO0FBQ25CLGVBQVMsTUFBTSxhQUFhO0FBQUEsUUFDM0I7QUFBQSxRQUNBLE9BQU8sQ0FBQyxNQUFNO0FBQUEsUUFDZCxTQUFTLE1BQU0sV0FBVztBQUFBLFVBQ3pCO0FBQUEsVUFDQSxVQUFVLElBQUksSUFBSSxLQUFLLE1BQU0sYUFBYSxZQUFZO0FBQUEsVUFDdEQ7QUFBQSxVQUNBLE1BQU07QUFBQSxVQUNOO0FBQUEsVUFDQSxVQUFVLE1BQU07QUFBQSxVQUNoQjtBQUFBLFVBQ0E7QUFBQSxVQUNBO0FBQUEsV0FFQyxLQUFLLENBQUMsV0FBVztBQUNqQixnQkFBTSxPQUFPLEdBQUcsTUFBTSxXQUFXLFFBQVEsUUFBUTtBQUNqRCxnQkFBTSxTQUFTLHNCQUFPLE9BQU8sS0FBSyxPQUFPLE1BQU0sY0FBUyxNQUFNLG9CQUFlLE9BQU8sT0FBTztBQUMzRixpQkFBTztBQUFBLFdBRVAsTUFBTSxDQUFDLFFBQVE7QUFDZixnQkFBTSxTQUFTLHNCQUFPLE9BQU8sS0FBSyxPQUFPLElBQUksY0FBUyxNQUFNO0FBQzVELGdCQUFNO0FBQUE7QUFBQTtBQUdUO0FBQUE7QUFHRCxVQUFNLFNBQVMsTUFBTSx1QkFBdUIsTUFBTSxPQUNoRCxLQUFLLENBQUMsWUFBWTtBQUNsQixZQUFNLFFBQVEsUUFBUSxZQUFZLFdBQVcsSUFBSSxTQUFTO0FBQzFELFlBQU0sU0FBUyxzQkFBTyxPQUFPLEtBQUssT0FBTyxNQUFNLGNBQVMsTUFBTSxvQkFBZSxPQUFPLFFBQVEsSUFBSSxRQUFRLFlBQVksVUFBVTtBQUM5SCxhQUFPO0FBQUEsT0FFUCxNQUFNLENBQUMsUUFBUTtBQUNmLFlBQU0sU0FBUyxzQkFBTyxPQUFPLEtBQUssT0FBTyxJQUFJLGNBQVMsTUFBTTtBQUM1RCxZQUFNO0FBQUE7QUFFUixVQUFNLFFBQVEsb0JBQW9CLFlBQVksYUFBYSxNQUFNO0FBQ2pFLGVBQVcsY0FBYyxPQUFPLEtBQUs7QUFDcEMsWUFBTSxZQUFZLE1BQU07QUFDeEIsVUFBSSxVQUFVLEtBQUs7QUFDbEIsY0FBTSxFQUFFLEtBQUssWUFBWSxVQUFVO0FBQ25DLFlBQUksU0FBUztBQUNaLGdCQUFNLFVBQVUsSUFBSSxJQUFJLElBQUksUUFBUSxRQUFRLE9BQU8sWUFBWTtBQUMvRCxjQUFJLE9BQU8sY0FBYyxXQUFXO0FBQ25DLGtCQUFNLElBQUksTUFBTSw2QkFBNkI7QUFBQSxtRUFBeUYsTUFBTTtBQUFBO0FBRTdJLGlCQUFPLGNBQWMsWUFBWTtBQUFBO0FBQUE7QUFHbkMsVUFBSSxnQkFBVSxRQUFWLG1CQUFlLFNBQVM7QUFDM0IsY0FBTSxFQUFFLEtBQUssWUFBWSxVQUFVO0FBQ25DLGNBQU0saUJBQWlCLElBQUksSUFBSSxJQUFJLFFBQVEsUUFBUSxPQUFPLFlBQVk7QUFDdEUsWUFBSSxPQUFPLGNBQWMsa0JBQWtCO0FBQzFDLGdCQUFNLElBQUksTUFDVCx3Q0FBd0M7QUFBQSwwRUFBZ0csTUFBTTtBQUFBO0FBR2hKLGVBQU8sY0FBYyxtQkFBbUI7QUFBQTtBQUFBO0FBRzFDLFVBQU0sYUFBYSxPQUFPLFlBQVksSUFBSSxDQUFDLGVBQWUsV0FBVyxVQUFVLE1BQU0sU0FBUyxXQUFXLFNBQVMsT0FBTztBQUN6SCxhQUFTLE1BQU0sYUFBYTtBQUFBLE1BQzNCO0FBQUEsTUFDQSxPQUFPO0FBQUEsTUFDUCxTQUFTLE1BQU0sV0FBVztBQUFBLFFBQ3pCO0FBQUEsUUFDQSxVQUFVLElBQUksSUFBSSxLQUFLLE1BQU0sYUFBYSxZQUFZO0FBQUEsUUFDdEQ7QUFBQSxRQUNBLE1BQU07QUFBQSxRQUNOO0FBQUEsUUFDQSxVQUFVLFdBQVc7QUFBQSxRQUNyQjtBQUFBLFFBQ0E7QUFBQSxRQUNBO0FBQUE7QUFBQTtBQUFBO0FBS0gsU0FBTyxFQUFFLFFBQVE7QUFBQTtBQUdsQixzQ0FBc0MsTUFBK0IsT0FBNEM7QUFDaEgsUUFBTSxFQUFFLGFBQWEsU0FBUyxZQUFZLGVBQWU7QUFDekQsTUFBSSxDQUFDO0FBQVksVUFBTSxJQUFJLE1BQU07QUFDakMsUUFBTSxXQUFXLElBQUksSUFBSSxLQUFLLE1BQU0sYUFBYSxZQUFZO0FBQzdELFFBQU0sTUFBTyxNQUFNLFdBQVcsY0FBYyxjQUFjO0FBQzFELFFBQU0sU0FBUyxNQUFNLG1CQUFtQixLQUFLLE9BQU8sT0FBTztBQUMzRCxhQUFXLElBQUksT0FBTztBQUN0QixTQUFPO0FBQUE7IiwKICAibmFtZXMiOiBbXQp9Cg==
