import { polyfill } from "@astropub/webapi";
import { performance } from "perf_hooks";
import { createVite } from "../create-vite.js";
import { defaultLogOptions, info } from "../logger.js";
import * as vite from "vite";
import * as msg from "../messages.js";
async function dev(config, options = { logging: defaultLogOptions }) {
  var _a;
  const devStart = performance.now();
  polyfill(globalThis, {
    exclude: "window document"
  });
  const viteUserConfig = vite.mergeConfig({
    mode: "development",
    server: {
      host: config.devOptions.hostname
    }
  }, config.vite || {});
  const viteConfig = await createVite(viteUserConfig, { astroConfig: config, logging: options.logging, mode: "dev" });
  const viteServer = await vite.createServer(viteConfig);
  await viteServer.listen(config.devOptions.port);
  const address = viteServer.httpServer.address();
  const site = config.buildOptions.site ? new URL(config.buildOptions.site) : void 0;
  info(options.logging, "astro", msg.devStart({ startupTime: performance.now() - devStart }));
  info(options.logging, "astro", msg.devHost({ address, site, https: !!((_a = viteUserConfig.server) == null ? void 0 : _a.https) }));
  return {
    address,
    stop: () => viteServer.close()
  };
}
export {
  dev as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvZGV2L2luZGV4LnRzIl0sCiAgIm1hcHBpbmdzIjogIkFBQUE7QUFFQTtBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBWUEsbUJBQWtDLFFBQXFCLFVBQXNCLEVBQUUsU0FBUyxxQkFBeUM7QUFuQmpJO0FBb0JDLFFBQU0sV0FBVyxZQUFZO0FBRTdCLFdBQVMsWUFBWTtBQUFBLElBQ3BCLFNBQVM7QUFBQTtBQUdWLFFBQU0saUJBQWlCLEtBQUssWUFDM0I7QUFBQSxJQUNDLE1BQU07QUFBQSxJQUNOLFFBQVE7QUFBQSxNQUNQLE1BQU0sT0FBTyxXQUFXO0FBQUE7QUFBQSxLQUcxQixPQUFPLFFBQVE7QUFFaEIsUUFBTSxhQUFhLE1BQU0sV0FBVyxnQkFBZ0IsRUFBRSxhQUFhLFFBQVEsU0FBUyxRQUFRLFNBQVMsTUFBTTtBQUMzRyxRQUFNLGFBQWEsTUFBTSxLQUFLLGFBQWE7QUFDM0MsUUFBTSxXQUFXLE9BQU8sT0FBTyxXQUFXO0FBQzFDLFFBQU0sVUFBVSxXQUFXLFdBQVk7QUFFdkMsUUFBTSxPQUFPLE9BQU8sYUFBYSxPQUFPLElBQUksSUFBSSxPQUFPLGFBQWEsUUFBUTtBQUM1RSxPQUFLLFFBQVEsU0FBUyxTQUFTLElBQUksU0FBUyxFQUFFLGFBQWEsWUFBWSxRQUFRO0FBQy9FLE9BQUssUUFBUSxTQUFTLFNBQVMsSUFBSSxRQUFRLEVBQUUsU0FBUyxNQUFNLE9BQU8sQ0FBQyxDQUFDLHNCQUFlLFdBQWYsbUJBQXVCO0FBRTVGLFNBQU87QUFBQSxJQUNOO0FBQUEsSUFDQSxNQUFNLE1BQU0sV0FBVztBQUFBO0FBQUE7IiwKICAibmFtZXMiOiBbXQp9Cg==
