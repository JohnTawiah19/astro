import { warn, debug } from "../logger.js";
import { generatePaginateFunction } from "./paginate.js";
import { validateGetStaticPathsModule, validateGetStaticPathsResult } from "../routing/index.js";
function stringifyParams(params) {
  return JSON.stringify(params, Object.keys(params).sort());
}
async function callGetStaticPaths(mod, route, isValidate, logging) {
  validateGetStaticPathsModule(mod);
  const resultInProgress = {
    rss: []
  };
  const staticPaths = await (await mod.getStaticPaths({
    paginate: generatePaginateFunction(route),
    rss: (data) => {
      resultInProgress.rss.push(data);
    }
  })).flat();
  const keyedStaticPaths = staticPaths;
  keyedStaticPaths.keyed = new Map();
  for (const sp of keyedStaticPaths) {
    const paramsKey = stringifyParams(sp.params);
    keyedStaticPaths.keyed.set(paramsKey, sp);
  }
  if (isValidate) {
    validateGetStaticPathsResult(keyedStaticPaths, logging);
  }
  return {
    rss: resultInProgress.rss,
    staticPaths: keyedStaticPaths
  };
}
class RouteCache {
  constructor(logging) {
    this.cache = {};
    this.logging = logging;
  }
  clearAll() {
    this.cache = {};
  }
  set(route, entry) {
    if (this.cache[route.component]) {
      warn(this.logging, "routeCache", `Internal Warning: route cache overwritten. (${route.component})`);
    }
    this.cache[route.component] = entry;
  }
  get(route) {
    return this.cache[route.component];
  }
}
function findPathItemByKey(staticPaths, params) {
  const paramsKey = stringifyParams(params);
  let matchedStaticPath = staticPaths.keyed.get(paramsKey);
  if (matchedStaticPath) {
    return matchedStaticPath;
  }
  debug("findPathItemByKey", `Unexpected cache miss looking for ${paramsKey}`);
  matchedStaticPath = staticPaths.find(({ params: _params }) => JSON.stringify(_params) === paramsKey);
}
export {
  RouteCache,
  callGetStaticPaths,
  findPathItemByKey
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvcmVuZGVyL3JvdXRlLWNhY2hlLnRzIl0sCiAgIm1hcHBpbmdzIjogIkFBQ0E7QUFFQTtBQUNBO0FBSUEseUJBQXlCLFFBQWdCO0FBRXhDLFNBQU8sS0FBSyxVQUFVLFFBQVEsT0FBTyxLQUFLLFFBQVE7QUFBQTtBQUduRCxrQ0FBeUMsS0FBd0IsT0FBa0IsWUFBcUIsU0FBK0M7QUFDdEosK0JBQTZCO0FBQzdCLFFBQU0sbUJBQW1CO0FBQUEsSUFDeEIsS0FBSztBQUFBO0FBRU4sUUFBTSxjQUFvQyxNQUN6QyxPQUFNLElBQUksZUFBZ0I7QUFBQSxJQUN6QixVQUFVLHlCQUF5QjtBQUFBLElBQ25DLEtBQUssQ0FBQyxTQUFTO0FBQ2QsdUJBQWlCLElBQUksS0FBSztBQUFBO0FBQUEsTUFHM0I7QUFFRixRQUFNLG1CQUFtQjtBQUN6QixtQkFBaUIsUUFBUSxJQUFJO0FBQzdCLGFBQVcsTUFBTSxrQkFBa0I7QUFDbEMsVUFBTSxZQUFZLGdCQUFnQixHQUFHO0FBQ3JDLHFCQUFpQixNQUFNLElBQUksV0FBVztBQUFBO0FBRXZDLE1BQUksWUFBWTtBQUNmLGlDQUE2QixrQkFBa0I7QUFBQTtBQUVoRCxTQUFPO0FBQUEsSUFDTixLQUFLLGlCQUFpQjtBQUFBLElBQ3RCLGFBQWE7QUFBQTtBQUFBO0FBY1IsaUJBQWlCO0FBQUEsRUFJdkIsWUFBWSxTQUFxQjtBQUZ6QixpQkFBeUM7QUFHaEQsU0FBSyxVQUFVO0FBQUE7QUFBQSxFQUloQixXQUFXO0FBQ1YsU0FBSyxRQUFRO0FBQUE7QUFBQSxFQUdkLElBQUksT0FBa0IsT0FBOEI7QUFJbkQsUUFBSSxLQUFLLE1BQU0sTUFBTSxZQUFZO0FBQ2hDLFdBQUssS0FBSyxTQUFTLGNBQWMsK0NBQStDLE1BQU07QUFBQTtBQUV2RixTQUFLLE1BQU0sTUFBTSxhQUFhO0FBQUE7QUFBQSxFQUcvQixJQUFJLE9BQStDO0FBQ2xELFdBQU8sS0FBSyxNQUFNLE1BQU07QUFBQTtBQUFBO0FBSW5CLDJCQUEyQixhQUF3QyxRQUFnQjtBQUN6RixRQUFNLFlBQVksZ0JBQWdCO0FBQ2xDLE1BQUksb0JBQW9CLFlBQVksTUFBTSxJQUFJO0FBQzlDLE1BQUksbUJBQW1CO0FBQ3RCLFdBQU87QUFBQTtBQUdSLFFBQU0scUJBQXFCLHFDQUFxQztBQUNoRSxzQkFBb0IsWUFBWSxLQUFLLENBQUMsRUFBRSxRQUFRLGNBQWMsS0FBSyxVQUFVLGFBQWE7QUFBQTsiLAogICJuYW1lcyI6IFtdCn0K
