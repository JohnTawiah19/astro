import htmlparser2 from "htmlparser2";
function injectTags(html, tags) {
  let output = html;
  if (!tags.length)
    return output;
  const pos = { "head-prepend": -1, head: -1, "body-prepend": -1, body: -1 };
  const parser = new htmlparser2.Parser({
    onopentag(tagname) {
      if (tagname === "head")
        pos["head-prepend"] = parser.endIndex + 1;
      if (tagname === "body")
        pos["body-prepend"] = parser.endIndex + 1;
    },
    onclosetag(tagname) {
      if (tagname === "head")
        pos["head"] = parser.startIndex;
      if (tagname === "body")
        pos["body"] = parser.startIndex;
    }
  });
  parser.write(html);
  parser.end();
  const lastToFirst = Object.entries(pos).sort((a, b) => b[1] - a[1]);
  lastToFirst.forEach(([name, i]) => {
    if (i === -1) {
      if (name === "head-prepend" || name === "head")
        i = 0;
      if (name === "body-prepend" || name === "body")
        i = html.length;
    }
    let selected = tags.filter(({ injectTo }) => {
      if (name === "head-prepend" && !injectTo) {
        return true;
      } else {
        return injectTo === name;
      }
    });
    if (!selected.length)
      return;
    output = output.substring(0, i) + serializeTags(selected) + html.substring(i);
  });
  return output;
}
function collectResources(html) {
  let resources = [];
  const parser = new htmlparser2.Parser({
    onopentag(tagname, attrs) {
      if (tagname === "link")
        resources.push(attrs);
    }
  });
  parser.write(html);
  parser.end();
  return resources;
}
const unaryTags = new Set(["link", "meta", "base"]);
function serializeTag({ tag, attrs, children }, indent = "") {
  if (unaryTags.has(tag)) {
    return `<${tag}${serializeAttrs(attrs)}>`;
  } else {
    return `<${tag}${serializeAttrs(attrs)}>${serializeTags(children, incrementIndent(indent))}</${tag}>`;
  }
}
function serializeTags(tags, indent = "") {
  if (typeof tags === "string") {
    return tags;
  } else if (tags && tags.length) {
    return tags.map((tag) => `${indent}${serializeTag(tag, indent)}
`).join("");
  }
  return "";
}
function serializeAttrs(attrs) {
  let res = "";
  for (const key in attrs) {
    if (typeof attrs[key] === "boolean") {
      res += attrs[key] ? ` ${key}` : ``;
    } else {
      res += ` ${key}=${JSON.stringify(attrs[key])}`;
    }
  }
  return res;
}
function incrementIndent(indent = "") {
  return `${indent}${indent[0] === "	" ? "	" : "  "}`;
}
export {
  collectResources,
  injectTags
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vLi4vc3JjL2NvcmUvcmVuZGVyL2Rldi9odG1sLnRzIl0sCiAgIm1hcHBpbmdzIjogIkFBRUE7QUFHTyxvQkFBb0IsTUFBYyxNQUF3QztBQUNoRixNQUFJLFNBQVM7QUFDYixNQUFJLENBQUMsS0FBSztBQUFRLFdBQU87QUFFekIsUUFBTSxNQUFNLEVBQUUsZ0JBQWdCLElBQUksTUFBTSxJQUFJLGdCQUFnQixJQUFJLE1BQU07QUFHdEUsUUFBTSxTQUFTLElBQUksWUFBWSxPQUFPO0FBQUEsSUFDckMsVUFBVSxTQUFTO0FBQ2xCLFVBQUksWUFBWTtBQUFRLFlBQUksa0JBQWtCLE9BQU8sV0FBVztBQUNoRSxVQUFJLFlBQVk7QUFBUSxZQUFJLGtCQUFrQixPQUFPLFdBQVc7QUFBQTtBQUFBLElBRWpFLFdBQVcsU0FBUztBQUNuQixVQUFJLFlBQVk7QUFBUSxZQUFJLFVBQVUsT0FBTztBQUM3QyxVQUFJLFlBQVk7QUFBUSxZQUFJLFVBQVUsT0FBTztBQUFBO0FBQUE7QUFHL0MsU0FBTyxNQUFNO0FBQ2IsU0FBTztBQUdQLFFBQU0sY0FBYyxPQUFPLFFBQVEsS0FBSyxLQUFLLENBQUMsR0FBRyxNQUFNLEVBQUUsS0FBSyxFQUFFO0FBQ2hFLGNBQVksUUFBUSxDQUFDLENBQUMsTUFBTSxPQUFPO0FBQ2xDLFFBQUksTUFBTSxJQUFJO0FBRWIsVUFBSSxTQUFTLGtCQUFrQixTQUFTO0FBQVEsWUFBSTtBQUNwRCxVQUFJLFNBQVMsa0JBQWtCLFNBQVM7QUFBUSxZQUFJLEtBQUs7QUFBQTtBQUUxRCxRQUFJLFdBQVcsS0FBSyxPQUFPLENBQUMsRUFBRSxlQUFlO0FBQzVDLFVBQUksU0FBUyxrQkFBa0IsQ0FBQyxVQUFVO0FBQ3pDLGVBQU87QUFBQSxhQUNEO0FBQ04sZUFBTyxhQUFhO0FBQUE7QUFBQTtBQUd0QixRQUFJLENBQUMsU0FBUztBQUFRO0FBQ3RCLGFBQVMsT0FBTyxVQUFVLEdBQUcsS0FBSyxjQUFjLFlBQVksS0FBSyxVQUFVO0FBQUE7QUFHNUUsU0FBTztBQUFBO0FBTUQsMEJBQTBCLE1BQTBCO0FBQzFELE1BQUksWUFBd0I7QUFDNUIsUUFBTSxTQUFTLElBQUksWUFBWSxPQUFPO0FBQUEsSUFFckMsVUFBVSxTQUFTLE9BQU87QUFDekIsVUFBSSxZQUFZO0FBQVEsa0JBQVUsS0FBSztBQUFBO0FBQUE7QUFHekMsU0FBTyxNQUFNO0FBQ2IsU0FBTztBQUNQLFNBQU87QUFBQTtBQWtDUixNQUFNLFlBQVksSUFBSSxJQUFJLENBQUMsUUFBUSxRQUFRO0FBRTNDLHNCQUFzQixFQUFFLEtBQUssT0FBTyxZQUFvQyxTQUFTLElBQVk7QUFDNUYsTUFBSSxVQUFVLElBQUksTUFBTTtBQUN2QixXQUFPLElBQUksTUFBTSxlQUFlO0FBQUEsU0FDMUI7QUFDTixXQUFPLElBQUksTUFBTSxlQUFlLFVBQVUsY0FBYyxVQUFVLGdCQUFnQixhQUFhO0FBQUE7QUFBQTtBQUlqRyx1QkFBdUIsTUFBMEMsU0FBUyxJQUFZO0FBQ3JGLE1BQUksT0FBTyxTQUFTLFVBQVU7QUFDN0IsV0FBTztBQUFBLGFBQ0csUUFBUSxLQUFLLFFBQVE7QUFDL0IsV0FBTyxLQUFLLElBQUksQ0FBQyxRQUFRLEdBQUcsU0FBUyxhQUFhLEtBQUs7QUFBQSxHQUFhLEtBQUs7QUFBQTtBQUUxRSxTQUFPO0FBQUE7QUFHUix3QkFBd0IsT0FBZ0Q7QUFDdkUsTUFBSSxNQUFNO0FBQ1YsYUFBVyxPQUFPLE9BQU87QUFDeEIsUUFBSSxPQUFPLE1BQU0sU0FBUyxXQUFXO0FBQ3BDLGFBQU8sTUFBTSxPQUFPLElBQUksUUFBUTtBQUFBLFdBQzFCO0FBQ04sYUFBTyxJQUFJLE9BQU8sS0FBSyxVQUFVLE1BQU07QUFBQTtBQUFBO0FBR3pDLFNBQU87QUFBQTtBQUdSLHlCQUF5QixTQUFTLElBQUk7QUFDckMsU0FBTyxHQUFHLFNBQVMsT0FBTyxPQUFPLE1BQU8sTUFBTztBQUFBOyIsCiAgIm5hbWVzIjogW10KfQo=
