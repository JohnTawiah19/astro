import { hydrationSpecifier, serializeListValue } from "./util.js";
import serializeJavaScript from "serialize-javascript";
function serializeProps(value) {
  return serializeJavaScript(value);
}
const HydrationDirectives = ["load", "idle", "media", "visible", "only"];
function extractDirectives(inputProps) {
  let extracted = {
    hydration: null,
    props: {}
  };
  for (const [key, value] of Object.entries(inputProps)) {
    if (key.startsWith("client:")) {
      if (!extracted.hydration) {
        extracted.hydration = {
          directive: "",
          value: "",
          componentUrl: "",
          componentExport: { value: "" }
        };
      }
      switch (key) {
        case "client:component-path": {
          extracted.hydration.componentUrl = value;
          break;
        }
        case "client:component-export": {
          extracted.hydration.componentExport.value = value;
          break;
        }
        case "client:component-hydration": {
          break;
        }
        default: {
          extracted.hydration.directive = key.split(":")[1];
          extracted.hydration.value = value;
          if (HydrationDirectives.indexOf(extracted.hydration.directive) < 0) {
            throw new Error(`Error: invalid hydration directive "${key}". Supported hydration methods: ${HydrationDirectives.map((d) => `"client:${d}"`).join(", ")}`);
          }
          if (extracted.hydration.directive === "media" && typeof extracted.hydration.value !== "string") {
            throw new Error('Error: Media query must be provided for "client:media", similar to client:media="(max-width: 600px)"');
          }
          break;
        }
      }
    } else if (key === "class:list") {
      extracted.props[key.slice(0, -5)] = serializeListValue(value);
    } else {
      extracted.props[key] = value;
    }
  }
  return extracted;
}
async function generateHydrateScript(scriptOptions, metadata) {
  const { renderer, result, astroId, props } = scriptOptions;
  const { hydrate, componentUrl, componentExport } = metadata;
  if (!componentExport) {
    throw new Error(`Unable to resolve a componentExport for "${metadata.displayName}"! Please open an issue.`);
  }
  let hydrationSource = "";
  if (renderer.hydrationPolyfills) {
    hydrationSource += `await Promise.all([${(await Promise.all(renderer.hydrationPolyfills.map(async (src) => `
  import("${await result.resolve(src)}")`))).join(", ")}]);
`;
  }
  hydrationSource += renderer.source ? `const [{ ${componentExport.value}: Component }, { default: hydrate }] = await Promise.all([import("${await result.resolve(componentUrl)}"), import("${await result.resolve(renderer.source)}")]);
  return (el, children) => hydrate(el)(Component, ${serializeProps(props)}, children);
` : `await import("${await result.resolve(componentUrl)}");
  return () => {};
`;
  const hydrationScript = {
    props: { type: "module", "data-astro-component-hydration": true },
    children: `import setup from '${await result.resolve(hydrationSpecifier(hydrate))}';
setup("${astroId}", {name:"${metadata.displayName}",${metadata.hydrateArgs ? `value: ${JSON.stringify(metadata.hydrateArgs)}` : ""}}, async () => {
  ${hydrationSource}
});
`
  };
  return hydrationScript;
}
export {
  extractDirectives,
  generateHydrateScript,
  serializeProps
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL3J1bnRpbWUvc2VydmVyL2h5ZHJhdGlvbi50cyJdLAogICJtYXBwaW5ncyI6ICJBQUVBO0FBQ0E7QUFJTyx3QkFBd0IsT0FBWTtBQUMxQyxTQUFPLG9CQUFvQjtBQUFBO0FBRzVCLE1BQU0sc0JBQXNCLENBQUMsUUFBUSxRQUFRLFNBQVMsV0FBVztBQWMxRCwyQkFBMkIsWUFBMEQ7QUFDM0YsTUFBSSxZQUE0QjtBQUFBLElBQy9CLFdBQVc7QUFBQSxJQUNYLE9BQU87QUFBQTtBQUVSLGFBQVcsQ0FBQyxLQUFLLFVBQVUsT0FBTyxRQUFRLGFBQWE7QUFDdEQsUUFBSSxJQUFJLFdBQVcsWUFBWTtBQUM5QixVQUFJLENBQUMsVUFBVSxXQUFXO0FBQ3pCLGtCQUFVLFlBQVk7QUFBQSxVQUNyQixXQUFXO0FBQUEsVUFDWCxPQUFPO0FBQUEsVUFDUCxjQUFjO0FBQUEsVUFDZCxpQkFBaUIsRUFBRSxPQUFPO0FBQUE7QUFBQTtBQUc1QixjQUFRO0FBQUEsYUFDRix5QkFBeUI7QUFDN0Isb0JBQVUsVUFBVSxlQUFlO0FBQ25DO0FBQUE7QUFBQSxhQUVJLDJCQUEyQjtBQUMvQixvQkFBVSxVQUFVLGdCQUFnQixRQUFRO0FBQzVDO0FBQUE7QUFBQSxhQUlJLDhCQUE4QjtBQUNsQztBQUFBO0FBQUEsaUJBRVE7QUFDUixvQkFBVSxVQUFVLFlBQVksSUFBSSxNQUFNLEtBQUs7QUFDL0Msb0JBQVUsVUFBVSxRQUFRO0FBRzVCLGNBQUksb0JBQW9CLFFBQVEsVUFBVSxVQUFVLGFBQWEsR0FBRztBQUNuRSxrQkFBTSxJQUFJLE1BQU0sdUNBQXVDLHNDQUFzQyxvQkFBb0IsSUFBSSxDQUFDLE1BQU0sV0FBVyxNQUFNLEtBQUs7QUFBQTtBQUluSixjQUFJLFVBQVUsVUFBVSxjQUFjLFdBQVcsT0FBTyxVQUFVLFVBQVUsVUFBVSxVQUFVO0FBQy9GLGtCQUFNLElBQUksTUFBTTtBQUFBO0FBR2pCO0FBQUE7QUFBQTtBQUFBLGVBR1EsUUFBUSxjQUFjO0FBRWhDLGdCQUFVLE1BQU0sSUFBSSxNQUFNLEdBQUcsT0FBTyxtQkFBbUI7QUFBQSxXQUNqRDtBQUNOLGdCQUFVLE1BQU0sT0FBTztBQUFBO0FBQUE7QUFJekIsU0FBTztBQUFBO0FBV1IscUNBQTRDLGVBQXFDLFVBQWlFO0FBQ2pKLFFBQU0sRUFBRSxVQUFVLFFBQVEsU0FBUyxVQUFVO0FBQzdDLFFBQU0sRUFBRSxTQUFTLGNBQWMsb0JBQW9CO0FBRW5ELE1BQUksQ0FBQyxpQkFBaUI7QUFDckIsVUFBTSxJQUFJLE1BQU0sNENBQTRDLFNBQVM7QUFBQTtBQUd0RSxNQUFJLGtCQUFrQjtBQUN0QixNQUFJLFNBQVMsb0JBQW9CO0FBQ2hDLHVCQUFtQixzQkFBdUIsT0FBTSxRQUFRLElBQUksU0FBUyxtQkFBbUIsSUFBSSxPQUFPLFFBQWdCO0FBQUEsWUFBZSxNQUFNLE9BQU8sUUFBUSxZQUFZLEtBQ2xLO0FBQUE7QUFBQTtBQUlGLHFCQUFtQixTQUFTLFNBQ3pCLFlBQVksZ0JBQWdCLDBFQUEwRSxNQUFNLE9BQU8sUUFBUSw0QkFBNEIsTUFBTSxPQUFPLFFBQ3BLLFNBQVM7QUFBQSxvREFFdUMsZUFBZTtBQUFBLElBRS9ELGlCQUFpQixNQUFNLE9BQU8sUUFBUTtBQUFBO0FBQUE7QUFJekMsUUFBTSxrQkFBa0I7QUFBQSxJQUN2QixPQUFPLEVBQUUsTUFBTSxVQUFVLGtDQUFrQztBQUFBLElBQzNELFVBQVUsc0JBQXNCLE1BQU0sT0FBTyxRQUFRLG1CQUFtQjtBQUFBLFNBQ2pFLG9CQUFvQixTQUFTLGdCQUFnQixTQUFTLGNBQWMsVUFBVSxLQUFLLFVBQVUsU0FBUyxpQkFBaUI7QUFBQSxJQUM1SDtBQUFBO0FBQUE7QUFBQTtBQUtILFNBQU87QUFBQTsiLAogICJuYW1lcyI6IFtdCn0K
