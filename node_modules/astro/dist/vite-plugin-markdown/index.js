var __getOwnPropSymbols = Object.getOwnPropertySymbols;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __propIsEnum = Object.prototype.propertyIsEnumerable;
var __objRest = (source, exclude) => {
  var target = {};
  for (var prop in source)
    if (__hasOwnProp.call(source, prop) && exclude.indexOf(prop) < 0)
      target[prop] = source[prop];
  if (source != null && __getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(source)) {
      if (exclude.indexOf(prop) < 0 && __propIsEnum.call(source, prop))
        target[prop] = source[prop];
    }
  return target;
};
import esbuild from "esbuild";
import fs from "fs";
import { transform } from "@astrojs/compiler";
function markdown({ config }) {
  return {
    name: "astro:markdown",
    enforce: "pre",
    async load(id) {
      if (id.endsWith(".md")) {
        let source = await fs.promises.readFile(id, "utf8");
        let render = config.markdownOptions.render;
        let renderOpts = {};
        if (Array.isArray(render)) {
          renderOpts = render[1];
          render = render[0];
        }
        if (typeof render === "string") {
          ({ default: render } = await import(render));
        }
        let renderResult = await render(source, renderOpts);
        let { frontmatter, metadata, code: astroResult } = renderResult;
        const _a = frontmatter, { layout = "", components = "", setup = "" } = _a, content = __objRest(_a, ["layout", "components", "setup"]);
        content.astro = metadata;
        const prelude = `---
${layout ? `import Layout from '${layout}';` : ""}
${components ? `import * from '${components}';` : ""}
${setup}
const $$content = ${JSON.stringify(content)}
---`;
        const imports = `${layout ? `import Layout from '${layout}';` : ""}
${setup}`.trim();
        if (/\bLayout\b/.test(imports)) {
          astroResult = `${prelude}
<Layout content={$$content}>

${astroResult}

</Layout>`;
        } else {
          astroResult = `${prelude}
${astroResult}`;
        }
        const filenameURL = new URL(`file://${id}`);
        const pathname = filenameURL.pathname.substr(config.projectRoot.pathname.length - 1);
        let { code: tsResult } = await transform(astroResult, {
          pathname,
          projectRoot: config.projectRoot.toString(),
          site: config.buildOptions.site,
          sourcefile: id,
          sourcemap: "inline",
          internalURL: "astro/internal"
        });
        tsResult = `
export const metadata = ${JSON.stringify(metadata)};
export const frontmatter = ${JSON.stringify(content)};
${tsResult}`;
        const { code, map } = await esbuild.transform(tsResult, { loader: "ts", sourcemap: "inline", sourcefile: id });
        return {
          code,
          map: null
        };
      }
      return null;
    }
  };
}
export {
  markdown as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vc3JjL3ZpdGUtcGx1Z2luLW1hcmtkb3duL2luZGV4LnRzIl0sCiAgIm1hcHBpbmdzIjogIjs7Ozs7Ozs7Ozs7Ozs7O0FBR0E7QUFDQTtBQUNBO0FBT2Usa0JBQWtCLEVBQUUsVUFBc0M7QUFDeEUsU0FBTztBQUFBLElBQ04sTUFBTTtBQUFBLElBQ04sU0FBUztBQUFBLFVBQ0gsS0FBSyxJQUFJO0FBQ2QsVUFBSSxHQUFHLFNBQVMsUUFBUTtBQUN2QixZQUFJLFNBQVMsTUFBTSxHQUFHLFNBQVMsU0FBUyxJQUFJO0FBRzVDLFlBQUksU0FBUyxPQUFPLGdCQUFnQjtBQUNwQyxZQUFJLGFBQWE7QUFDakIsWUFBSSxNQUFNLFFBQVEsU0FBUztBQUMxQix1QkFBYSxPQUFPO0FBQ3BCLG1CQUFTLE9BQU87QUFBQTtBQUVqQixZQUFJLE9BQU8sV0FBVyxVQUFVO0FBQy9CLFVBQUMsR0FBRSxTQUFTLFdBQVcsTUFBTSxPQUFPO0FBQUE7QUFFckMsWUFBSSxlQUFlLE1BQU0sT0FBTyxRQUFRO0FBQ3hDLFlBQUksRUFBRSxhQUFhLFVBQVUsTUFBTSxnQkFBZ0I7QUFHbkQsY0FBaUUsa0JBQXpELFdBQVMsSUFBSSxhQUFhLElBQUksUUFBUSxPQUFtQixJQUFaLG9CQUFZLElBQVosQ0FBN0MsVUFBYSxjQUFpQjtBQUN0QyxnQkFBUSxRQUFRO0FBQ2hCLGNBQU0sVUFBVTtBQUFBLEVBQ2xCLFNBQVMsdUJBQXVCLGFBQWE7QUFBQSxFQUM3QyxhQUFhLGtCQUFrQixpQkFBaUI7QUFBQSxFQUNoRDtBQUFBLG9CQUNrQixLQUFLLFVBQVU7QUFBQTtBQUUvQixjQUFNLFVBQVUsR0FBRyxTQUFTLHVCQUF1QixhQUFhO0FBQUEsRUFDbEUsUUFBUTtBQUVOLFlBQUksYUFBYSxLQUFLLFVBQVU7QUFDL0Isd0JBQWMsR0FBRztBQUFBO0FBQUE7QUFBQSxFQUE0QztBQUFBO0FBQUE7QUFBQSxlQUN2RDtBQUNOLHdCQUFjLEdBQUc7QUFBQSxFQUFZO0FBQUE7QUFHOUIsY0FBTSxjQUFjLElBQUksSUFBSSxVQUFVO0FBQ3RDLGNBQU0sV0FBVyxZQUFZLFNBQVMsT0FBTyxPQUFPLFlBQVksU0FBUyxTQUFTO0FBR2xGLFlBQUksRUFBRSxNQUFNLGFBQWEsTUFBTSxVQUFVLGFBQWE7QUFBQSxVQUNyRDtBQUFBLFVBQ0EsYUFBYSxPQUFPLFlBQVk7QUFBQSxVQUNoQyxNQUFNLE9BQU8sYUFBYTtBQUFBLFVBQzFCLFlBQVk7QUFBQSxVQUNaLFdBQVc7QUFBQSxVQUNYLGFBQWE7QUFBQTtBQUdkLG1CQUFXO0FBQUEsMEJBQTZCLEtBQUssVUFBVTtBQUFBLDZCQUM5QixLQUFLLFVBQVU7QUFBQSxFQUMxQztBQUdFLGNBQU0sRUFBRSxNQUFNLFFBQVEsTUFBTSxRQUFRLFVBQVUsVUFBVSxFQUFFLFFBQVEsTUFBTSxXQUFXLFVBQVUsWUFBWTtBQUV6RyxlQUFPO0FBQUEsVUFDTjtBQUFBLFVBQ0EsS0FBSztBQUFBO0FBQUE7QUFJUCxhQUFPO0FBQUE7QUFBQTtBQUFBOyIsCiAgIm5hbWVzIjogW10KfQo=
